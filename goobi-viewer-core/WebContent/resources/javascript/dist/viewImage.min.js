/*!
 * This file is part of the Goobi viewer - a content presentation and management application for digitized objects.
 *
 * Visit these websites for more information.
 * - http://www.intranda.com
 * - http://digiverso.com
 *
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
var _MIN_DESKEW_ANGLE=-44.9,_MAX_DESKEW_ANGLE=45,ImageView=function(){"use strict";var g=!1,l={global:{divId:"map",zoomSlider:".zoom-slider",zoomSliderHandle:".zoom-slider-handle",overlayGroups:[{name:"searchHighlighting",styleClass:"coords-highlighting",interactive:!1},{name:"ugc",styleClass:"ugcBox",interactive:!0}],zoomSpeed:1.25,maxZoomLevel:2,minZoomLevel:1,imageControlsActive:!0,visibilityRatio:.2,loadImageTimeout:6e5,maxParallelImageLoads:2,adaptContainerHeight:!1,fitToContainer:!0,footerHeight:0,rememberZoom:!1,rememberRotation:!1,panHomeOnZoomOut:!0,showControls:!1},image:{initialRotation:0,mimeType:"image/jpeg"},getOverlayGroup:function(e){for(var t=this.global.overlayGroups,o=0;o<t.length;o++){var i=t[o];if(i.name===e)return i}},getCoordinates:function(e){var t=this.image.highlightCoords;if(t)for(var o=0;o<t.length;o++){var i=t[o];if(i.name===e)return i}}},c={};function o(e){var t=e.userData;if(0<t.config.global.footerHeight){var o=t.config.global.footerHeight,i=new OpenSeadragon.Point(0,t.container.height()-o),r=new OpenSeadragon.Point(t.container.width(),o);t.canvasScale||(t.canvasScale=t.viewer.drawer.context.canvas.width/t.viewer.drawer.context.canvas.clientWidth),1!=t.canvasScale&&(i=i.times(t.canvasScale),r=r.times(t.canvasScale)),t.viewer.drawer.context.drawImage(t.footerImage,i.x,i.y,r.x,r.y)}}function s(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var i=t.source.width/t.source.height,r=t.viewport.getRotation(),n=new OpenSeadragon.Point(.5,.5/i).times(-1),a=t.viewport.getCenter(!0),s=new OpenSeadragon.Point(t.viewport.getBoundsNoRotate(!0).width/2,t.viewport.getBoundsNoRotate(!0).height/2),l=u(n.plus(a),r,!0),g=s.minus(l);return u(e.times(1/o).minus(g),r,!1).minus(n)}function h(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var i=t.source.width/t.source.height,r=t.viewport.getRotation(),n=new OpenSeadragon.Point(.5,.5/i).times(-1),a=t.viewport.getCenter(!0),s=new OpenSeadragon.Point(t.viewport.getBoundsNoRotate(!0).width/2,t.viewport.getBoundsNoRotate(!0).height/2),l=u(n.plus(a),r,!0),g=s.minus(l),c=u(n.plus(e),r,!0);return g.plus(c).times(o)}function u(e,t,o){var i,r,n=t*Math.PI/180;return o?(i=e.x*Math.cos(n)-e.y*Math.sin(n),r=e.x*Math.sin(n)+e.y*Math.cos(n)):(i=e.x*Math.cos(n)+e.y*Math.sin(n),r=-e.x*Math.sin(n)+e.y*Math.cos(n)),new OpenSeadragon.Point(i,r)}function v(e,t){var o=t*Math.PI/180,i=Math.abs(Math.sin(o)),r=Math.abs(Math.cos(o)),n=e.width*i+e.height*r,a=e.width*r+e.height*i,s=Math.abs(a),l=Math.abs(n),g=s-e.width,c=l-e.height;return new OpenSeadragon.Rect(-g/2,-c/2,s,l)}function r(e,i){var t=Q.defer();return ImageView.TileSourceResolver.resolveAsJson(e).then(function(e){return g&&console.log("IIIF image info ",e),function(e,t){if(t){t.replace(/[\{\}]/,"");var t=JSON.parse(t),o=[];t.forEach(function(e){o.push({width:parseInt(e),height:parseInt(e)})}),0<o.length?e.sizes=o:delete e.sizes}}(e,i.global.imageSizes),function(e,o){if(o){if("string"==typeof o){var t=o.replace(/(\d+)/,'"$1"').replace("=",":");o=JSON.parse(t)}var i=[];Object.keys(o).forEach(function(e){var t=o[e];i.push({width:parseInt(e),height:parseInt(e),scaleFactors:t})}),e.tiles=i}}(e,i.global.tileSizes),e.tiles&&0<e.tiles.length?new OpenSeadragon.IIIFTileSource(e):function(o,i){g&&console.log("Creating legacy tilesource from imageInfo ",o);var r=i.image.mimeType;r=(r=r.replace("image/","")).replace("jpeg","jpg").replace("tiff","tif");var e,n=[];Array.isArray(o)?(o.forEach(function(e){e.mimetype=i.image.mimeType}),e=new OpenSeadragon.LegacyTileSource(o)):o.sizes?(o.sizes.forEach(function(e){g&&(console.log("Image level width = ",e.width),console.log("Image level height = ",e.height));var t={mimetype:i.image.mimeType,url:o["@id"].replace("/info.json","")+"/full/"+e.width+",/0/default."+r,width:o.width,height:o.height};g&&console.log("Created level ",t),n.push(t)}),e=new OpenSeadragon.LegacyTileSource(n)):e=new OpenSeadragon.ImageTileSource({url:o["@id"].replace("/info.json","")+"/full/full/0/default."+r,crossOriginPolicy:"Anonymous",buildPyramid:!1});return e}(e,i)},function(e){if(ImageView.TileSourceResolver.isURI(i.image.tileSource)){g&&console.log("Image URL",i.image.tileSource);var t=new OpenSeadragon.ImageTileSource({url:i.image.tileSource,buildPyramid:!0,crossOriginPolicy:!1});return t}var o="Failed to load tilesource from "+t;return g&&console.log(o),Q.reject(o)}).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}),t.promise}function d(e){return(e%360+360)%360}function m(e){return e+=_MAX_DESKEW_ANGLE,e/=90,e=parseInt(e),d(e*=90)}function f(e){return e+=_MAX_DESKEW_ANGLE,e=parseFloat(e%90),e=d(e-=_MAX_DESKEW_ANGLE),e=_MAX_DESKEW_ANGLE<e?e-360:e}return c.Image=function(e){this.config=jQuery.extend(!0,{},l),jQuery.extend(!0,this.config,e),this.container=$("#"+this.config.global.divId),g&&console.log("initializing image view with config ",this.config)},c.Image.prototype.load=function(){g&&(console.log("##############################"),console.log("osViewer.init"),console.log("##############################")),this.config.image.mimeType=this.config.image.mimeType.replace("jpeg","jpg");var e=this.config.image.tileSource;"string"==typeof e&&e.startsWith("[")?e=JSON.parse(e):$.isArray(e)||(e=[e]);for(var t=[],o=0;o<e.length;o++){var i=r(e[o],this.config);t.push(i)}var l=this;return Q.all(t).then(function(e){for(var t=Number.MAX_VALUE,o=Number.MAX_VALUE,i=Number.MAX_VALUE,r=0;r<e.length;r++){var n=e[r];t=Math.min(t,n.width),o=Math.min(o,n.height),i=Math.min(i,n.aspectRatio),l.config.image.originalImageWidth||(l.config.image.originalImageWidth=n.width),l.config.image.originalImageHeight||(l.config.image.originalImageHeight=n.height)}g&&(console.log("original image size: ",l.config.image.originalImageWidth,l.config.image.originalImageHeight),console.log("Min aspect ratio = "+i));for(var a=0,s=0;s<e.length;s++){n=e[s];e[s]={tileSource:n,width:n.aspectRatio/i,x:a,y:0},a+=e[s].width}return l.loadImage(e)})},c.Image.prototype.loadImage=function(e){g&&console.log("Loading image with tilesource: ",e),this.loadFooter();var t=$("#"+this.config.global.divId),o={tileSources:e,id:this.config.global.divId,prefixUrl:this.config.resourcePath+"/javascript/openseadragon/images/",immediateRender:!1,visibilityRatio:this.config.global.visibilityRatio,sequenceMode:!1,degrees:this.config.image.initialRotation?this.config.image.initialRotation:0,zoomPerClick:1,showRotationControl:!0,showNavigationControl:this.config.global.showControls,minZoomLevel:this.config.global.minZoomLeve,maxZoomLevel:this.config.global.maxZoomLevel*this.config.image.originalImageWidth/t.width(),zoomPerScroll:this.config.global.zoomSpeed,mouseNavEnabled:1<this.config.global.zoomSpeed,homeButton:this.config.global.zoomHome,rotateLeftButton:this.config.global.rotateLeft,rotateRightButton:this.config.global.rotateRight,timeout:this.config.global.loadImageTimeout,blendTime:.5,alwaysBlend:!1,imageLoaderLimit:this.config.global.maxParallelImageLoads,loadTilesWithAjax:!0,ajaxHeaders:{token:this.config.global.webApiToken},viewportMargins:{top:0,left:0,right:0,bottom:this.config.global.footerHeight}};console.log("osconfig ",o),this.viewer=new OpenSeadragon(o);var i,r,n,a=Q.defer();this.observables=(i=window,r=this,(n={}).viewerOpen=Rx.Observable.create(function(t){r.viewer.addOnceHandler("open",function(e){return e.osState="open",Number.isNaN(e.eventSource.viewport.getHomeBounds().x)?t.onError("Unknow error loading image from ",l.image.tileSource):t.onNext(e)}),r.viewer.addOnceHandler("open-failed",function(e){return e.osState="open-failed",console.error("Failed to open openseadragon "),t.onError(e)})}),n.firstTileLoaded=Rx.Observable.create(function(t){r.viewer.addOnceHandler("tile-loaded",function(e){return e.osState="tile-loaded",t.onNext(e)}),r.viewer.addOnceHandler("tile-load-failed",function(e){return e.osState="tile-load-failed",console.error("Failed to load tile"),t.onError(e)})}),n.viewerZoom=Rx.Observable.create(function(t){r.viewer.addHandler("zoom",function(e){return t.onNext(e)})}),n.animationComplete=Rx.Observable.create(function(t){r.viewer.addHandler("animation-finish",function(e){return t.onNext(e)})}),n.viewportUpdate=Rx.Observable.create(function(t){r.viewer.addHandler("update-viewport",function(e){return t.onNext(e)})}),n.animation=Rx.Observable.create(function(t){r.viewer.addHandler("animation",function(e){return t.onNext(e)})}),n.viewerRotate=Rx.Observable.create(function(t){r.viewer.addHandler("rotate",function(e){return e.osState="rotate",t.onNext(e)})}),n.canvasResize=Rx.Observable.create(function(t){r.viewer.addHandler("resize",function(e){return e.osState="resize",t.onNext(e)})}),n.windowResize=Rx.Observable.fromEvent(i,"resize").map(function(e){return e.osState="window resize",e}),n.overlayRemove=Rx.Observable.create(function(t){r.viewer.addHandler("remove-overlay",function(e){return t.onNext(e)})}),n.overlayUpdate=Rx.Observable.create(function(t){r.viewer.addHandler("update-overlay",function(e){return t.onNext(e)})}),n.levelUpdate=Rx.Observable.create(function(t){r.viewer.addHandler("update-level",function(e){return t.onNext(e)})}),n.redrawRequired=n.viewerOpen.merge(n.viewerRotate.merge(n.canvasResize).debounce(10)).map(function(e){var t={};return r.controls&&(t=r.controls.getLocation()),"open"===e.osState&&(t.zoom=r.viewer.viewport.getHomeZoom(),r.config.image.location&&(t=r.config.image.location)),e.targetLocation=t,e}).publish(),n),(this.config.global.rotationSlider||this.config.global.rotationInput)&&function(r){var e=r.config.image.initialRotation,t=f(e);r.rotation=m(e);var n=r.config.global,a=r.viewer;n.rotationSlider&&($("#"+n.rotationSlider).slider({orientation:"vertical",min:_MIN_DESKEW_ANGLE,max:_MAX_DESKEW_ANGLE,step:.1,slide:function(e,t){var o=-t.value,i=f(o);a.viewport.setRotation(i+r.rotation)}}),$("#"+n.rotationSlider).slider("option","value",-t));n.rotationInput&&$("#"+n.rotationInput).on("blur",function(e){var t=d(e.target.value),o=f(t);r.rotation=m(t),a.viewport.setRotation(t),n.rotationSlider&&$("#"+n.rotationSlider).slider("option","value",-o)});a.addHandler("rotate",function(e){var t=d(e.degrees),o=f(t);if(r.rotation=m(a.viewport.getRotation()),n.rotationInput){var i=r.rotation+o;$("#"+n.rotationInput).val(i.toFixed(1)).change()}})}(this);var s=this;return this.observables.viewerOpen.subscribe(function(e,t){a.resolve(s)},function(e){a.reject(e)}),this.observables.redrawRequired.subscribe(function(e){g&&console.log("viewer "+e.osState+"ed with target location ",e.targetLocation),s.redraw()}),c.Controls&&(this.controls=new c.Controls(this.config,this)),c.ZoomSlider&&(this.zoomSlider=new c.ZoomSlider(this.config,this),this.onFirstTileLoaded().then(function(){s.zoomSlider&&s.zoomSlider.init()})),c.Overlays&&(this.overlays=new c.Overlays(this.config,this)),c.DrawRect&&(this.drawRect=new c.DrawRect(this.config,this)),c.TransformRect&&(this.transformRect=new c.TransformRect(this.config,this)),this.observables.redrawRequired.connect(),a.promise},c.Image.prototype.getObservables=function(){return this.observables},c.Image.prototype.hasFooter=function(){return null!=this.footerImage},c.Image.prototype.getConfig=function(){return this.config},c.Image.prototype.loadFooter=function(){if(this.config.image.baseFooterUrl&&0<this.config.global.footerHeight){this.footerImage=new Image,this.footerImage.src=this.config.image.baseFooterUrl.replace("{width}",Math.round(this.container.width())).replace("{height}",Math.round(this.config.global.footerHeight)),this.footerImage.src=this.config.image.baseFooterUrl.replace("/full/max/","/full/!"+Math.round(this.container.width())+","+Math.round(this.config.global.footerHeight)+"/");var t=this;this.footerImage.onload=function(){var e;g&&(console.log("loading footer image ",t.footerImage),console.log("Calculating image Footer size")),(e=t)&&e.viewer&&(o({userData:e}),e.viewer.removeHandler("update-viewport",o),e.viewer.addHandler("update-viewport",o,e))}}},c.Image.prototype.getOverlayGroup=function(e){return this.config.getOverlayGroup(e)},c.Image.prototype.getHighlightCoordinates=function(e){return this.config.getCoordinates(e)},c.Image.prototype.getSizes=function(){return this.sizes},c.Image.prototype.getImageInfo=function(){return this.viewer?this.viewer.tileSources:null},c.Image.prototype.close=function(){g&&console.log("Closing openSeadragon viewer"),this.viewer&&this.viewer.destroy()},c.Image.prototype.redraw=function(){this.controls&&this.controls.setPanning(!0),this.sizes=function(e){g&&(console.log("viewImage: calcualte sizes"),console.log("Home zoom = ",e.viewer.viewport.getHomeZoom()));var t=new ImageView.Measures(e);e.config.global.adaptContainerHeight&&t.resizeCanvas();null!=e.viewer&&e.viewer.viewport.setMargins({bottom:t.footerHeight+t.calculateExcessHeight()});g&&console.log("sizes: ",t);return t}(this)},c.Image.prototype.onFirstTileLoaded=function(){var t=Q.defer();return this.observables?this.observables.firstTileLoaded.subscribe(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject("No observables defined"),t.promise},c.Image.prototype.scaleToOpenSeadragon=function(e){var t=this.viewer.world.getItemAt(0).source.dimensions,o=this.sizes.originalImageSize.x/t.x;return e=(e=e.times(1/t.x)).times(1/o)},c.Image.prototype.scaleToImage=function(e){var t=this.viewer.world.getItemAt(0).source.dimensions,o=this.sizes.originalImageSize.x/t.x;return roi=roi.times(t.x),roi=roi.times(o),roi},c.Image.prototype.scaleToRotatedImage=function(e){var t=this.viewer.world.getItemAt(0).source.dimensions,o={x:this.config.image.originalImageWidth,y:this.config.image.originalImageHeight},i=new OpenSeadragon.Rect(0,0,t.x,t.y),r=new OpenSeadragon.Rect(0,0,o.x,o.y),n=this.viewer.viewport.getRotation(),a=v(i,n),s=v(r,n).width/a.width;return e=(e=e.times(t.x)).times(s)},c.Image.prototype.scaleToOpenSeadragonCoordinates=function(e){var t=this.viewer.world.getItemAt(0).source.dimensions,o={x:this.config.image.originalImageWidth,y:this.config.image.originalImageHeight},i=new OpenSeadragon.Rect(0,0,t.x,t.y),r=new OpenSeadragon.Rect(0,0,o.x,o.y),n=this.viewer.viewport.getRotation(),a=v(i,n),s=v(r,n).width/a.width;return e=(e=e.times(1/t.x)).times(1/s)},c.Image.prototype.convertRectFromOpenSeadragonToImage=function(e){var t=ImageView.convertRectFromImageToRotatedImage(e,this.viewer);return this.scaleToRotatedImage(t)},c.Image.prototype.convertRectFromImageToOpenSeadragon=function(e){var t=this.scaleToOpenSeadragonCoordinates(e);return ImageView.convertRectFromRotatedImageToImage(t,this.viewer)},c.convertCoordinatesFromImageToCanvas=function(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var i=h(e.getTopLeft(),t),r=h(e.getBottomRight(),t),n=i.x+.5*(r.x-i.x),a=i.y+.5*(r.y-i.y);return new OpenSeadragon.Rect(n-.5*e.width*o,a-.5*e.height*o,e.width*o,e.height*o)},c.convertCoordinatesFromCanvasToImage=function(e,t){var o=t.drawer.context.canvas.width/t.viewport.getBoundsNoRotate(!0).width;o/=window.devicePixelRatio;var i=s(e.getTopLeft(),t),r=s(e.getBottomRight(),t),n=i.x+.5*(r.x-i.x),a=i.y+.5*(r.y-i.y);return new OpenSeadragon.Rect(n-.5*e.width/o,a-.5*e.height/o,e.width/o,e.height/o)},c.convertPointFromImageToCanvas=function(e,t){return h(e,t)},c.convertPointFromCanvasToImage=function(e,t){return s(e,t)},c.convertRectFromImageToRotatedImage=function(e,t){var o=t.viewport.getRotation(),i=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),r=v(i,o),n=i.width/i.height,a=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/n)),s=v(a,o),l=e.getCenter(),g=u(a.getCenter().times(-1).plus(l),o,!0),c=new OpenSeadragon.Point(s.width/2,s.height/2).times(-1),h=g.minus(c);return new OpenSeadragon.Rect(h.x-e.width/2,h.y-e.height/2,e.width,e.height)},c.convertRectFromRotatedImageToImage=function(e,t){var o=t.viewport.getRotation(),i=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),r=v(i,o),n=i.width/i.height,a=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/n)),s=v(a,o),l=a.getCenter().times(-1),g=new OpenSeadragon.Point(s.width/2,s.height/2).times(-1),c=e.getCenter(),h=u(g.plus(c),o,!1).minus(l);return new OpenSeadragon.Rect(h.x-e.width/2,h.y-e.height/2,e.width,e.height)},c.convertPointFromImageToRotatedImage=function(e,t){var o=t.viewport.getRotation(),i=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),r=v(i,o),n=i.width/i.height,a=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/n)),s=v(a,o),l=e,g=u(a.getCenter().times(-1).plus(l),o,!0),c=new OpenSeadragon.Point(s.width/2,s.height/2).times(-1);return g.minus(c)},c.convertPointFromRotatedImageToImage=function(e,t){var o=t.viewport.getRotation(),i=new OpenSeadragon.Rect(0,0,t.source.width,t.source.height),r=v(i,o),n=i.width/i.height,a=(r.width,r.height,new OpenSeadragon.Rect(0,0,1,1/n)),s=v(a,o),l=a.getCenter().times(-1),g=e;return u(new OpenSeadragon.Point(s.width/2,s.height/2).times(-1).plus(g),o,!1).minus(l)},c.getPointInRotatedImage=function(e,t){var o=t.source.width/t.source.height,i=t.viewport.getRotation(),r=new OpenSeadragon.Point(.5,.5/o).times(-1);return u(r.plus(e),i,!1).minus(r)},c.getPointInUnrotatedImage=function(e,t){var o=t.source.width/t.source.height,i=t.viewport.getRotation(),r=new OpenSeadragon.Point(.5,.5/o).times(-1);return u(u(r,i,!1).plus(e),i,!0).minus(r)},c}();String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.substring(0,e.length).localeCompare(e)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return 0===this.substring(this.length-e.length,this.length).localeCompare(e)}),Array.prototype.find||(Array.prototype.find=function(e){for(var t=0;t<this.length;t++){var o=this[t];if(e(o))return o}}),Number.isNaN||(Number.isNaN=function(e){return e!=e});var viewImage=ImageView=function(e){"use strict";var n=!1,t=null,a={navSelector:".reading-mode__navigation",viewSelector:"#contentView",imageContainerSelector:".reading-mode__content-view-image",imageSelector:"#readingModeImage",sidebarSelector:"#contentSidebar",sidebarToggleButton:".reading-mode__content-sidebar-toggle",sidebarInnerSelector:".reading-mode__content-sidebar-inner",sidebarTabsSelector:".reading-mode__content-sidebar-tabs",sidebarTabContentSelector:".tab-content",sidebarTocWrapperSelector:".widget-toc-elem-wrapp",sidebarStatus:"",useTabs:!0,useAccordeon:!1,msg:{}};function o(){n&&(console.log("---------- _setViewportHeight() ----------"),console.log("_setViewportHeight: view = ",a.viewSelector),console.log("_setViewportHeight: image = ",a.imageSelector),console.log("_setViewportHeight: sidebar = ",a.sidebarSelector),console.log("_setViewportHeight: sidebarInner = ",a.sidebarInnerSelector),console.log("_setViewportHeight: sidebarTabs = ",a.sidebarTabsSelector));var e=$(window).outerHeight(),t=$(a.navSelector).outerHeight(),o=e-t;n&&(console.log("_setViewportHeight: viewportHeight = ",e),console.log("_setViewportHeight: navHeight = ",t),console.log("_setViewportHeight: newHeight = ",o)),$(a.viewSelector).css("height",o),$(a.imageSelector).css("height",o),$(a.sidebarSelector).css("height",o),$(a.sidebarInnerSelector).css("height",o)}function i(){n&&(console.log("---------- _setSidebarTabHeight() ----------"),console.log("_setSidebarTabHeight: sidebarTabs = ",a.sidebarTabsSelector));var e=$(window).outerHeight(),t=e-$(a.navSelector).outerHeight(),o=$(a.sidebarTabsSelector).position(),i=t-o.top-15,r=$(".nav-tabs").outerHeight();n&&(console.log("_setSidebarTabHeight: tabPos = ",o),console.log("_setSidebarTabHeight: tabHeight = ",i)),768<e&&($(a.sidebarTabsSelector).css("height",i),$(a.sidebarTabContentSelector).css("height",i-r),$(a.sidebarTocWrapperSelector).css("min-height",i-r))}function r(){n&&(console.log("---------- _setSidebarButtonPosition() ----------"),console.log("_setSidebarButtonPosition: view = ",a.viewSelector));var e=$(a.viewSelector).outerHeight()/2;n&&console.log("_setSidebarButtonPosition: viewHalfHeight = ",e),$(a.sidebarToggleButton).css("top",e)}return e.readingMode={init:function(e){if(n&&(console.log("##############################"),console.log("osViewer.readingMode.init"),console.log("##############################"),console.log("osViewer.readingMode.init: config - ",e)),$.extend(!0,a,e),!viewerJS.helper.checkLocalStorage())return!1;a.sidebarStatus=localStorage.getItem("sidebarStatus"),""!==a.sidebarStatus&&void 0!==a.sidebarStatus||localStorage.setItem("sidebarStatus","true"),o(),a.useTabs&&i(),r(),function(){n&&(console.log("---------- _checkSidebarStatus() ----------"),console.log("_checkSidebarStatus: sidebarStatus = ",a.sidebarStatus));"false"!==a.sidebarStatus||($('[data-toggle="sidebar"]').removeClass("in"),$(".reading-mode__content-sidebar").removeClass("in").prev().removeClass("in"))}(),setTimeout(function(){!function(){n&&console.log("---------- _showContent() ----------");$(a.viewSelector).removeClass("invisible"),$(a.sidebarSelector).removeClass("invisible")}()},500),a.useAccordeon&&(t=localStorage.getItem("activePanel"),$(".panel-collapse").each(function(){$(this).removeClass("in")}),null===t&&(localStorage.setItem("activePanel","#collapseOne"),t=localStorage.getItem("activePanel")),$(t).addClass("in"),$('a[data-toggle="collapse"]').on("click",function(){var e=$(this).attr("href");localStorage.setItem("activePanel",e)})),$('[data-toggle="sidebar"]').on("click",function(){$(this).toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").toggleClass("in"),$(this).parents(".reading-mode__content-sidebar").prev().toggleClass("in"),a.sidebarStatus=localStorage.getItem("sidebarStatus"),"false"===a.sidebarStatus?localStorage.setItem("sidebarStatus","true"):localStorage.setItem("sidebarStatus","false"),setTimeout(function(){viewImage.loadFooter()},300)}),$(window).on("resize",function(){o(),a.useTabs&&i(),r()}),$(window).on("orientationchange",function(){o(),a.useTabs&&i(),r()}),"undefined"!=typeof jsf&&jsf.ajax.addOnEvent(function(e){switch(e.status){case"success":o(),a.useTabs&&i(),r()}})}},e}(ImageView=function(f){"use strict";var p=!1,r="focus",n="highlight";function w(t,o){p&&(console.log("viewImage.overlays._drawOverlay"),console.log("overlay: ",t));var i=document.createElement("div");$(i).attr("id","overlay_"+t.id);var e=o.image.config.getOverlayGroup(t.group);e&&(p&&console.log("overlay style",e),$(i).addClass(e.styleClass),t.type===f.Overlays.OverlayTypes.LINE&&function(e,t){p&&(console.log("Overlays _rotate: angle - "+e),console.log("Overlays _rotate: mapElement - "+t));if(0!==e){$(t).css("-moz-transform","rotate("+e+"deg)"),$(t).css("-webkit-transform","rotate("+e+"deg)"),$(t).css("-ms-transform","rotate("+e+"deg)"),$(t).css("-o-transform","rotate("+e+"deg)"),$(t).css("transform","rotate("+e+"deg)");var o=Math.sin(e),i=Math.cos(e);$(t).css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+i+", M12="+o+", M21=-"+o+", M22="+i+", sizingMethod='auto expand'")}}(t.angle,i),e.interactive&&(i.focus=function(e){e?($(i).addClass(r),function(o,e,t){if(e.title){var i=t.sizes.$container.offset(),r=$(o).offset().top,n=$(o).offset().left,a=($(o).outerHeight(),n+$(o).outerWidth()),s=$("<div class='tooltipp'>"+e.title+"</div>");$("body").append(s);var l=parseFloat(s.css("padding-top"));s.css("max-width",a-n),s.css("top",Math.max(i.top+l,r-s.outerHeight()-l)),s.css("left",Math.max(i.left+l,n)),s.attr("id","tooltip_"+e.id),t.observables.animation.do(function(){var e=Math.max($(o).offset().top,i.top),t=Math.max($(o).offset().left,i.left);s.css("top",Math.max(i.top+l,e-s.outerHeight()-l)),s.css("left",Math.max(i.left+l,t))}).takeWhile(function(){return 0<$(".tooltipp").length}).subscribe()}}(i,t,o.image)):($(i).removeClass(r),$(".tooltipp#tooltip_"+t.id).remove()),o.overlayFocusHook&&o.overlayFocusHook(t,e)},i.highlight=function(e){e?$(i).addClass(n):$(i).removeClass(n)},$(i).on("mouseover",function(){p&&console.log("Overlays _drawOverlay: mouse over - "+e.name),o.focusBox(t.group,t.id)}),$(i).on("mouseout",function(){p&&console.log("Overlays _drawOverlay: mouse out - "+e.name),i.focus(!1)}),$(i).on("click",function(){o.overlayClickHook&&o.overlayClickHook(t)})),t.element=i,o.image.viewer.addOverlay(i,t.rect,0))}function a(e,t,o){return t.x>e.x-o&&t.x<e.x+e.width+o&&t.y>e.y-o&&t.y<e.y+e.height+o}return f.Overlays=function(e,t){p&&(console.log("##############################"),console.log("osViewer.overlays.init"),console.log("##############################")),this.config=e,this.image=t,this.overlays=[];var r=this;this.image.observables.overlayRemove.subscribe(function(e){e.element&&$(e.element).remove()}),this.config.image.highlightCoords&&this.image.observables.viewerOpen.subscribe(function(e){for(var t=0;t<r.config.image.highlightCoords.length;t++){var o=r.config.image.highlightCoords[t],i=o.pageIndex;r.draw(o.name,o.displayTooltip,i)}r.initializedCallback&&r.initializedCallback()})},f.Overlays.prototype.onInitialized=function(e){var t=this.initializedCallback;this.initializedCallback=function(){t&&t(),e()}},f.Overlays.prototype.onFocus=function(o){var i=this.overlayFocusHook;this.overlayFocusHook=function(e,t){i&&i(e,t),o(e,t)}},f.Overlays.prototype.onClick=function(t){var o=this.overlayClickHook;this.overlayClickHook=function(e){o&&o(e),t(e)}},f.Overlays.prototype.getOverlays=function(){return this.overlays.slice()},f.Overlays.prototype.getRects=function(){return this.overlays.filter(function(e){return e.type===f.Overlays.OverlayTypes.RECTANGLE}).slice()},f.Overlays.prototype.getLines=function(){return this.overlays.filter(function(e){return e.type===f.Overlays.OverlayTypes.LINE}).slice()},f.Overlays.prototype.draw=function(e,t,o){p&&(console.log("osViewer.overlays.draw: group - "+e),console.log("osViewer.overlays.draw: displayTitle - "+t),console.log("osViewer.overlays.draw: imageIndex - "+o));var i=this.config.getCoordinates(e);if(i)for(var r=0;r<i.coordinates.length;r++){var n=i.coordinates[r],a=t&&4<n.length?n[4]:"",s=5<n.length?n[5]:r;this.createRectangle(n[0],n[1],n[2]-n[0],n[3]-n[1],a,s,e,o)}},f.Overlays.prototype.unDraw=function(t){p&&console.log("osViewer.overlays.unDraw: group - "+t);this.overlays=this.overlays.filter(function(e){return e.group!==t||(this.image.viewer.removeOverlay(e.element),!1)})},f.Overlays.prototype.highlight=function(t){p&&console.log("osViewer.overlays.highlight: group - "+t),this.overlays.filter(function(e){return e.group===t}).forEach(function(e){e.element&&e.element.highlight(!0)})},f.Overlays.prototype.unHighlight=function(t){p&&console.log("osViewer.overlays.unHighlight: group - "+t),this.overlays.filter(function(e){return e.group===t}).forEach(function(e){e.element&&e.element.highlight(!1)})},f.Overlays.prototype.focusBox=function(t,o){p&&(console.log("osViewer.overlays.highlightBox: group - "+t),console.log("osViewer.overlays.highlightBox: id - "+o)),this.overlays.filter(function(e){return e.group===t}).forEach(function(e){e.element&&e.element.focus(e.id===o)})},f.Overlays.prototype.addOverlay=function(e){p&&console.log("osViewer.overlays.addOverlay: overlay - "+e),this.overlays.push(e),e.element&&this.image.viewer.updateOverlay(e.element,e.rect,0)},f.Overlays.prototype.removeOverlay=function(e){if(e){p&&console.log("Removing overlay "+e.id);var t=this.overlays.indexOf(e);this.overlays.splice(t,1),e.element&&this.image.viewer.removeOverlay(e.element)}},f.Overlays.prototype.drawRect=function(e,t,o,i){p&&(console.log("osViewer.overlays.drawRect: rectangle - "+e),console.log("osViewer.overlays.drawRect: group - "+t)),this.createRectangle(e.x,e.y,e.width,e.height,o||"",i||"",t)},f.Overlays.prototype.drawLine=function(e,t,o){p&&(console.log("osViewer.overlays.drawLine: point1 - "+e),console.log("osViewer.overlays.drawLine: point2 - "+t),console.log("osViewer.overlays.drawLine: group - "+o)),this.createLine(e.x,e.y,t.x,t.y,"","",o)},f.Overlays.prototype.showOverlay=function(e){e&&!e.element&&(w(e,this),this.overlayFocusHook&&this.overlayFocusHook(e,!0))},f.Overlays.prototype.hideOverlay=function(e){var t;e&&e.element&&this.drawingOverlay!=e&&(t=e,this.image.viewer.removeOverlay(t.element),t.element=null,this.overlayFocusHook&&this.overlayFocusHook(e,!1))},f.Overlays.prototype.getOverlay=function(t,o){return this.overlays.find(function(e){return o?e.id===t&&e.group===o:e.id===t})},f.Overlays.prototype.getCoordinates=function(e){return p&&console.log("getCoordinates - overlay",e),e.type===f.Overlays.OverlayTypes.RECTANGLE?this.image.viewer.viewport.viewportToImageRectangle(e.rect):e.type===f.Overlays.OverlayTypes.LINE?{point1:this.image.viewer.viewport.viewportToImageCoordinates(e.poin1),point2:this.image.viewer.viewport.viewportToImageCoordinates(e.poin2)}:void 0},f.Overlays.prototype.getDrawingOverlay=function(){return this.drawingOverlay},f.Overlays.prototype.setDrawingOverlay=function(e){this.drawingOverlay=e},f.Overlays.prototype.showHiddenOverlays=function(){var t=this;this.image.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,t){var o=e.position,i=viewerJS.helper.detectIEVersion();i&&10===i&&(o.x+=$(window).scrollLeft(),o.y+=$(window).scrollTop());var r=t.image.viewer.viewport.viewerElementToViewportCoordinates(o);t.overlays.forEach(function(e){a(e.rect,r,0)?t.showOverlay(e):t.hideOverlay(e)})}(e,t)}}]})},f.Overlays.prototype.contains=function(e,t,o){return null==o&&(o=0),a(e,t,o)},f.Overlays.OverlayTypes={RECTANGLE:"rectangle",LINE:"line"},f.Overlays.prototype.createLine=function(e,t,o,i,r,n,a){p&&(console.log("------------------------------"),console.log("Overlays _createLine: x1 - "+e),console.log("Overlays _createLine: y1 - "+t),console.log("Overlays _createLine: x2 - "+o),console.log("Overlays _createLine: y2 - "+i),console.log("Overlays _createLine: title - "+r),console.log("Overlays _createLine: id - "+n),console.log("Overlays _createLine: group - "+a),console.log("------------------------------"));var s=new OpenSeadragon.Point(e,t),l=new OpenSeadragon.Point(o,i),g=s.distanceTo(l),c=function(e,t){p&&(console.log("Overlays _calculateAngle: p1 - "+e),console.log("Overlays _calculateAngle: p2 - "+t));var o=t.x-e.x,i=t.y-e.y;return 0<o?180*Math.atan(i/o)/Math.PI:o<0?180*Math.atan(i/o)/Math.PI+180:i<0?270:90}(s,l),h=(180-c)/2;t+=g/2*Math.sin(c*Math.PI/180),e-=g/2*Math.sin(c*Math.PI/180)/Math.tan(h*Math.PI/180);var u=this.image.viewer.viewport.imageToViewportRectangle(e,t,g,1),v=this.image.viewer.viewport.imageToViewportCoordinates(s),d=this.image.viewer.viewport.imageToViewportCoordinates(l),m={type:f.Overlays.OerlayTypes.LINE,rect:u,angle:c,point1:v,point2:d,group:a,id:n,title:r};this.config.getOverlayGroup(m.group).hidden||w(m,this),this.overlays.push(m)},f.Overlays.prototype.createRectangle=function(e,t,o,i,r,n,a,s){p&&(console.log("------------------------------"),console.log("Overlays _createRectangle: x - "+e),console.log("Overlays _createRectangle: y - "+t),console.log("Overlays _createRectangle: width - "+o),console.log("Overlays _createRectangle: height - "+i),console.log("Overlays _createRectangle: title - "+r),console.log("Overlays _createRectangle: id - "+n),console.log("Overlays _createRectangle: group - "+a),console.log("Overlays _createRectangle: imageIndex - "+s),console.log("------------------------------")),s||(s=0);var l=this.image.viewer.world.getItemAt(s).imageToViewportRectangle(e,t,o,i),g={type:f.Overlays.OverlayTypes.RECTANGLE,rect:l,group:a,id:n,title:r};this.config.getOverlayGroup(g.group).hidden||w(g,this),this.overlays.push(g)},f}(ImageView=function(l){"use strict";if(!l||!l.Overlay)throw"imageView and imageView.Overlay must be initialized first";var n="default",a=4;return l.Transform=function(e,t,o){var i;this.viewer=e,this.style=t,this.startCondition=o,this.active=!0,this.transforming=!1,this.currentOverlay=null,this.drawArea=null,this.startPoint=null,this.overlays=[],this.finishedObservable=new Rx.Subject,(i=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){var t;t=e,i.isTransforming()&&(t.preventDefaultAction=!0)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){if(t.isTransforming()){var o=new OpenSeadragon.Point(e.position.x,e.position.y),i=l.convertCoordinatesFromImageToCanvas(t.currentOverlay.rect,t.viewer),r=null,n=null;if(t.drawArea===l.Overlay.HitAreas.TOPLEFT)r=new OpenSeadragon.Point(Math.min(o.x,i.getBottomRight().x),Math.min(o.y,i.getBottomRight().y)),n=i.getBottomRight();else if(t.drawArea===l.Overlay.HitAreas.TOPRIGHT)r=new OpenSeadragon.Point(i.getTopLeft().x,Math.min(o.y,i.getBottomRight().y)),n=new OpenSeadragon.Point(Math.max(o.x,i.getTopLeft().x),i.getBottomRight().y);else if(t.drawArea===l.Overlay.HitAreas.BOTTOMLEFT)r=new OpenSeadragon.Point(Math.min(o.x,i.getBottomRight().x),i.getTopLeft().y),n=new OpenSeadragon.Point(i.getBottomRight().x,Math.max(o.y,i.getTopLeft().y));else if(t.drawArea===l.Overlay.HitAreas.BOTTOMRIGHT)r=i.getTopLeft(),n=new OpenSeadragon.Point(Math.max(o.x,i.getTopLeft().x),Math.max(o.y,i.getTopLeft().y));else if(t.drawArea===l.Overlay.HitAreas.LEFT)r=new OpenSeadragon.Point(Math.min(o.x,i.getBottomRight().x),i.getTopLeft().y),n=i.getBottomRight();else if(t.drawArea===l.Overlay.HitAreas.RIGHT)r=i.getTopLeft(),n=new OpenSeadragon.Point(Math.max(o.x,i.getTopLeft().x),i.getBottomRight().y);else if(t.drawArea===l.Overlay.HitAreas.TOP)r=new OpenSeadragon.Point(i.getTopLeft().x,Math.min(o.y,i.getBottomRight().y)),n=i.getBottomRight();else if(t.drawArea===l.Overlay.HitAreas.BOTTOM)r=i.getTopLeft(),n=new OpenSeadragon.Point(i.getBottomRight().x,Math.max(o.y,i.getTopLeft().y));else if(t.drawArea===l.Overlay.HitAreas.CENTER&&t.startPoint){var a=t.startPoint.x-o.x,s=t.startPoint.y-o.y;i.x-=a,i.y-=s,t.startPoint=o}r&&n&&(i=new OpenSeadragon.Rect(r.x,r.y,n.x-r.x,n.y-r.y)),t.currentOverlay.rect=l.convertCoordinatesFromCanvasToImage(i,t.viewer),t.viewer.forceRedraw(),e.preventDefaultAction=!0}}(e,i)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){if(t.currentOverlay&&t.drawArea){var o=new OpenSeadragon.Point(e.position.x,e.position.y);return t.startPoint=o,t.transforming=!0,e.preventDefaultAction=!0,console.log("start transforming at ",t.startPoint)}t.transforming=!1}}(e,i)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){var t,o;t=e,(o=i).isTransforming()&&(o.transforming=!1,t.preventDefaultAction=!0)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){var t,o;t=e,(o=i).isActive()&&(o.transforming&&o.finishedObservable.onNext(o.currentOverlay),o.transforming=!1,t.preventDefaultAction=!0)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,t){if(!t.isTransforming()&&t.isActive()&&t.startCondition(e.originalEvent)){var o=new OpenSeadragon.Point(e.position.x,e.position.y),i=t.getContainingOverlay(o),r=t.viewer.element;i?(t.currentOverlay=i,t.drawArea=i.getHitArea(o,a,!0)):(t.currentOverlay=null,t.drawArea=null),t.drawArea?$(r).css({cursor:l.Overlay.HitAreas.getCursor(t.drawArea)}):$(r).css({cursor:n}),e.preventDefaultAction=!0}}(e,i)}}]})},l.Transform.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},l.Transform.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},l.Transform.prototype.finishedTransforming=function(){return this.finishedObservable},l.Transform.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},l.Transform.prototype.isActive=function(){return this.active},l.Transform.prototype.isTransforming=function(){return this.transforming},l.Transform.prototype.getContainingOverlay=function(e){for(var t in this.overlays){var o=this.overlays[i];if(o.contains(e,a,!0))return o}return null},l}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";var n="default",a="not-allowed";return e.Remove=function(e,t){var i;this.viewer=e,this.startCondition=t,this.active=!0,this.currentOverlay=null,this.overlays=[],this.finishedObservable=new Rx.Subject,(i=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){var t,o;t=e,(o=i).isActive()&&o.startCondition(t.originalEvent)&&o.currentOverlay&&(o.currentOverlay.remove(),o.finishedObservable.onNext(o.currentOverlay),o.currentOverlay=null)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){var o=e.position,i=t.getContainingOverlay(o),r=t.viewer.element;t.currentOverlay=i||null,t.currentOverlay?$(r).css({cursor:a}):$(r).css({cursor:n}),e.preventDefaultAction=!0}}(e,i)}}]})},e.Remove.prototype.addOverlay=function(e){return!this.overlays.includes(e)&&(this.overlays.push(e),!0)},e.Remove.prototype.removeOverlay=function(e){if(this.overlays.includes(e)){var t=this.overlays.indexOf(e);return this.overlays.splice(t,1),!0}return!1},e.Remove.prototype.finishedRemoving=function(){return this.finishedObservable},e.Remove.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Remove.prototype.isActive=function(){return this.active},e.Remove.prototype.getContainingOverlay=function(e){for(var t in this.overlays){var o=this.overlays[t];if(o.contains(e,4,!0))return o}return null},e}(ImageView=function(e){"use strict";if(!e||!e.Overlay)throw"imageView and imageView.Overlay must be initialized first";function i(e,t,o){e=e.times(window.devicePixelRatio),o.beginPath(),o.lineWidth=t.borderWidth,o.strokeStyle=t.borderColor,o.rect(e.x,e.y,e.width,e.height),o.stroke()}return e.Draw=function(e,t,o){var i;this.viewer=e,this.style=t,this.startCondition=o,this.active=!0,this.drawing=!1,this.currentRect=null,this.startPoint=null,this.finishedObservable=new Rx.Subject,(i=this).viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){var t;t=e,i.isActive()&&(t.preventDefaultAction=!0)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){var o=new OpenSeadragon.Point(e.position.x,e.position.y);t.updateOverlay(o),e.preventDefaultAction=!0}}(e,i)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.isActive()&&t.startCondition(e.originalEvent)){var o=new OpenSeadragon.Point(e.position.x,e.position.y);t.createEmptyRectAt(o),e.preventDefaultAction=!1,t.drawing=!0}}(e,i)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.isDrawing()){t.drawing=!1;var o=ImageView.convertCoordinatesFromCanvasToImage(t.currentRect,t.viewer),i=new ImageView.Overlay(o,t.viewer,t.style);console.log("rect ",i),t.finishedObservable.onNext(i),e.preventDefaultAction=!0}}(e,i)}}]})},e.Draw.prototype.finishedDrawing=function(){return this.finishedObservable},e.Draw.prototype.close=function(){this.active=!1,this.finishedObservable.onCompleted()},e.Draw.prototype.isActive=function(){return this.active},e.Draw.prototype.isDrawing=function(){return this.drawing},e.Draw.prototype.createEmptyRectAt=function(e){this.currentRect=new OpenSeadragon.Rect(e.x,e.y,0,0),this.startPoint=e,i(this.currentRect,this.style,this.viewer.drawer.context)},e.Draw.prototype.updateOverlay=function(t){this.viewer.forceRedraw();var o=this;this.viewer.addOnceHandler("update-viewport",function(e){o.isDrawing()&&(o.currentRect.x=Math.min(o.startPoint.x,t.x),o.currentRect.y=Math.min(o.startPoint.y,t.y),o.currentRect.width=Math.abs(o.startPoint.x-t.x),o.currentRect.height=Math.abs(o.startPoint.y-t.y),i(o.currentRect,o.style,o.viewer.drawer.context))})},e}(ImageView=function(e){"use strict";return e.Measures=function(e){this.config=e.getConfig(),this.$container=$("#"+this.config.global.divId),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()),this.originalImageSize=new OpenSeadragon.Point(this.getTotalImageWidth(e.getImageInfo()),this.getMaxImageHeight(e.getImageInfo())),this.footerHeight=this.config.global.footerHeight,this.rotation=null!=e.viewer?e.viewer.viewport.getRotation():0,this.xPadding=this.outerCanvasSize.x-this.innerCanvasSize.x,this.yPadding=this.outerCanvasSize.y-this.innerCanvasSize.y,this.innerCanvasSize.y-=this.footerHeight,this.fitToHeight()?this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.y/this.ratio(this.getRotatedSize(this.originalImageSize)),this.innerCanvasSize.y):this.imageDisplaySize=new OpenSeadragon.Point(this.innerCanvasSize.x,this.innerCanvasSize.x*this.ratio(this.getRotatedSize(this.originalImageSize))),this.rotated()&&(this.imageDisplaySize=this.getRotatedSize(this.imageDisplaySize))},e.Measures.prototype.getMaxImageWidth=function(e){var t=0;if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o];i.tileSource&&(correction=i.width,i=i.tileSource),t=Math.max(t,i.width*correction)}return t},e.Measures.prototype.getMaxImageHeight=function(e){var t=0;if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o],r=1;i.tileSource&&(r=i.width,i=i.tileSource),t=Math.max(t,i.height*r)}return t},e.Measures.prototype.getTotalImageWidth=function(e){var t=0;if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o],r=1;i.tileSource&&(r=i.width,i=i.tileSource),t+=i.width*r}return t},e.Measures.prototype.getTotalImageHeight=function(e){var t=0;if(e&&0<e.length)for(var o=0;o<e.length;o++){var i=e[o];i.tileSource&&(correction=i.width,i=i.tileSource),t+=i.height*correction}return t},e.Measures.prototype.getImageHomeSize=function(){var e=this.rotated()?1/this.ratio(this.originalImageSize):this.ratio(this.originalImageSize);if(this.fitToHeight())var t=(o=this.innerCanvasSize.y)/e;else var o=(t=this.innerCanvasSize.x)*e;return this.getRotatedSize(new OpenSeadragon.Point(t,o))},e.Measures.prototype.rotated=function(){return this.rotation%180!=0},e.Measures.prototype.landscape=function(){return this.ratio(this.originalImageSize)<1},e.Measures.prototype.ratio=function(e){return e.y/e.x},e.Measures.prototype.getRotatedSize=function(e){return new OpenSeadragon.Point(this.rotated()?e.y:e.x,this.rotated()?e.x:e.y)},e.Measures.prototype.fitToHeight=function(){return!this.config.global.adaptContainerHeight&&this.ratio(this.getRotatedSize(this.originalImageSize))>this.ratio(this.innerCanvasSize)},e.Measures.prototype.resizeCanvas=function(){this.config.global.adaptContainerHeight&&this.$container.height(this.getRotatedSize(this.imageDisplaySize).y+this.footerHeight),this.outerCanvasSize=new OpenSeadragon.Point(this.$container.outerWidth(),this.$container.outerHeight()),this.innerCanvasSize=new OpenSeadragon.Point(this.$container.width(),this.$container.height()-this.footerHeight)},e.Measures.prototype.calculateExcessHeight=function(){var e=this.getRotatedSize(this.getImageHomeSize());return this.config.global.adaptContainerHeight||this.fitToHeight()?0:.5*(this.innerCanvasSize.y-e.y)},e}(ImageView=function(n){"use strict";var a=!1,s="drawing",l=5,g=.01,i=!1,c=!0;return n.DrawRect=function(e,t){a&&(console.log("##############################"),console.log("osViewer.drawRect.init"),console.log("##############################")),this.config=e,this.image=t;var o=this;this.viewerInputHook=t.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e){if(i)e.preventDefaultAction=!0}(e)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){{if(t.drawing){var o=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),i=new OpenSeadragon.Rect(t.drawPoint.x,t.drawPoint.y,o.x-t.drawPoint.x,o.y-t.drawPoint.y);return o.x<t.drawPoint.x&&(i.x=o.x,i.width=t.drawPoint.x-o.x),o.y<t.drawPoint.y&&(i.y=o.y,i.height=t.drawPoint.y-o.y),t.image.viewer.updateOverlay(t.drawElement,i,0),e.preventDefaultAction=!0}if(t.active&&t.drawPoint){var r=t.image.overlays.getDrawingOverlay();if(r&&t.image.transformRect&&t.image.transformRect.isActive()&&t.image.overlays.contains(r.rect,t.drawPoint,g))t.drawPoint=null,a&&console.log("Action overlaps active overlay");else{t.drawing=!0,r&&c&&t.image.overlays.removeOverlay(r),t.drawElement=document.createElement("div"),t.overlayGroup&&$(t.drawElement).addClass(t.overlayGroup.styleClass),$(t.drawElement).addClass(s);var i=new OpenSeadragon.Rect(t.drawPoint.x,t.drawPoint.y,0,0);t.image.viewer.addOverlay(t.drawElement,i,1)}e.preventDefaultAction=!0}}}(e,o)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.active)t.drawPoint=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),e.preventDefaultAction=!1}(e,o)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.drawing){t.drawing=!1;var o=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),i=new OpenSeadragon.Rect(t.drawPoint.x,t.drawPoint.y,o.x-t.drawPoint.x,o.y-t.drawPoint.y);o.x<t.drawPoint.x&&(i.x=o.x,i.width=t.drawPoint.x-o.x),o.y<t.drawPoint.y&&(i.y=o.y,i.height=t.drawPoint.y-o.y),i.hitBox={l:i.x-l,t:i.y-l,r:i.x+i.width+l,b:i.y+i.height+l};var r={type:n.Overlays.OverlayTypes.RECTANGLE,element:t.drawElement,rect:i,group:t.overlayGroup.name};t.image.overlays.setDrawingOverlay(r),t.finishHook&&t.finishHook(r),e.preventDefaultAction=!0}}(e,o)}}]})},n.DrawRect.prototype.startDrawing=function(e,t){this.active=!0,this.overlayGroup=e,this.finishHook=t},n.DrawRect.prototype.endDrawing=function(e){this.active=!1,this.overlayGroup=null,this.finishHook=null,this.drawElement&&e?this.image.viewer.removeOverlay(this.drawElement):$(this.drawElement).removeClass(s)},n.DrawRect.prototype.isActive=function(){return this.active},n.DrawRect.prototype.isDrawing=function(){return this.drawing},n.DrawRect.prototype.removeLastDrawnElement=function(){this.drawElement&&this.image.viewer.removeOverlay(this.drawElement)},n}(ImageView=function(e){"use strict";function n(e){return"number"==typeof e&&!Number.isNaN(e)}return e.Controls.Persistence=function(t,o){if("undefined"!=typeof Storage){var e=null,i=t.global.persistenceId;if(t.global.persistZoom||t.global.persistRotation){try{e=JSON.parse(localStorage.imageLocation)}catch(e){0}e&&(n((r=e).x)&&n(r.y)&&n(r.zoom)&&n(r.rotation))&&e.persistenceId===i&&(t.image.location={},t.global.persistZoom&&(t.image.location.zoom=e.zoom,t.image.location.x=e.x,t.image.location.y=e.y),t.global.persistRotation?t.image.location.rotation=e.rotation:t.image.location.rotation=0),window.onbeforeunload=function(){var e=o.controls.getLocation();e.persistenceId=t.global.persistenceId,localStorage.imageLocation=JSON.stringify(e)}}}var r},e}(ImageView=function(l){"use strict";if(!l)throw"Image view must exist";function t(e){var t=e.userData,o=t.viewer.drawer.context,i=ImageView.convertCoordinatesFromImageToCanvas(t.rect,t.viewer).times(window.devicePixelRatio);o.beginPath(),o.lineWidth=t.style.borderWidth,o.strokeStyle=t.style.borderColor,o.rect(i.x,i.y,i.width,i.height),o.stroke()}function n(e,t,o){return t.x>e.getTopLeft().x-o&&t.x<e.getBottomRight().x+o&&t.y>e.getTopLeft().y-o&&t.y<e.getBottomRight().y+o}function o(e){return e*e}function a(e,t){return o(e.x-t.x)+o(e.y-t.y)}function g(e,t){return Math.sqrt(a(e,t))}function c(e,t,o){return Math.sqrt(function(e,t,o){var i=a(t,o);if(0==i)return a(e,t);var r=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/i;return a(e,r<0?t:1<r?o:{x:t.x+r*(o.x-t.x),y:t.y+r*(o.y-t.y)})}(e,t,o))}return l.Overlay=function(e,t,o){this.viewer=t,this.rect=e,this.style=o},l.Overlay.prototype.getRotation=function(){return this.viewer.viewport.getRotation()},l.Overlay.prototype.remove=function(){this.eventHandler&&(this.viewer.removeHandler("update-viewport",this.eventHandler,this),this.viewer.forceRedraw())},l.Overlay.prototype.draw=function(){this.eventHandler&&this.viewer.removeHandler("update-viewport",this.eventHandler,this),t({userData:this}),this.eventHandler=function(e){t(e)},this.viewer.addHandler("update-viewport",this.eventHandler,this)},l.Overlay.prototype.contains=function(e,t,o){return n(o?l.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect,e,t)},l.Overlay.prototype.getHitArea=function(e,t,o){var i=o?l.convertCoordinatesFromImageToCanvas(this.rect,this.viewer):this.rect;if(n(i,e,t)){var r=function(e,t,o){var i=g(t,e.getTopLeft()),r=g(t,e.getBottomLeft()),n=g(t,e.getTopRight()),a=g(t,e.getBottomRight()),s=Math.min(i,Math.min(n,Math.min(r,a)));if(s<=o){if(i===s)return l.Overlay.HitAreas.TOPLEFT;if(n===s)return l.Overlay.HitAreas.TOPRIGHT;if(r===s)return l.Overlay.HitAreas.BOTTOMLEFT;if(a===s)return l.Overlay.HitAreas.BOTTOMRIGHT}return""}(i,e,t);r||(r=function(e,t,o){var i=c(t,e.getTopLeft(),e.getBottomLeft()),r=c(t,e.getBottomLeft(),e.getBottomRight()),n=c(t,e.getTopRight(),e.getBottomRight()),a=c(t,e.getTopLeft(),e.getTopRight()),s=Math.min(i,Math.min(n,Math.min(a,r)));if(s<=o){if(i===s)return l.Overlay.HitAreas.LEFT;if(n===s)return l.Overlay.HitAreas.RIGHT;if(a===s)return l.Overlay.HitAreas.TOP;if(r===s)return l.Overlay.HitAreas.BOTTOM}return""}(i,e,t))}return r},l.Overlay.convertStringToRect=function(e){var t=e.split(",");if(t&&4==t.length)return new OpenSeadragon.Rect(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));throw"Cannot convert string '"+e+"' to Rectangle"},l.Overlay.convertRectToString=function(e,t){return t||(t=0),e.x.toFixed(t)+","+e.y.toFixed(t)+","+e.width.toFixed(t)+","+e.height.toFixed(t)},l.Overlay.drawPoint=function(e,t,o,i){!function(e){var t=e.userData[0].times(window.devicePixelRatio),o=e.userData[1],i=e.userData[2],r=e.userData[3],n=o.drawer.context;n.beginPath(),i&&(n.fillStyle=i);n.arc(t.x,t.y,r,0,2*Math.PI,!0),n.fill()}({userData:[e,t,o,i]})},l.Overlay.HitAreas={TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e){return e===this.TOPLEFT||e===this.BOTTOMRIGHT?"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?"nesw-resize":e===this.TOP||e===this.BOTTOM?"ns-resize":e===this.RIGHT||e===this.LEFT?"ew-resize":e===this.CENTER?"move":DEFAULT_CURSOR}},l}(ImageView=function(i){"use strict";return i.Controls=function(e,t){this.config=e,this.image=t;var o=this;i.Controls.Persistence&&(this.persistence=new i.Controls.Persistence(e,t)),this.config.global.controls&&($(this.config.global.controls.rotateLeft).on("click",function(){o.rotateLeft()}),$(this.config.global.controls.rotateRight).on("click",function(){o.rotateRight()}),$(this.config.global.controls.reset).on("click",function(){o.reset(!0)})),t.observables&&(t.observables.redrawRequired.sample(t.observables.viewportUpdate).subscribe(function(e){o.setLocation(e),o.setPanning(!1)}),t.config.global.panHomeOnZoomOut&&t.observables.viewerZoom.subscribe(function(e){o.isPanning()||t.viewer.viewport.getZoom()<=t.viewer.viewport.minZoomLevel&&(o.setPanning(!0),o.goHome(!0),o.setPanning(!1))})),0<$("#fullscreenTemplate").length&&($("#fullscreenTemplate").on("mousemove",function(){o.fullscreenControlsFadeout()}),$("#fullscreenMap").on("touchmove",function(){o.fullscreenControlsFadeout()}).on("touchend",function(){o.fullscreenControlsFadeout()}))},i.Controls.prototype.getLocation=function(){return{x:this.getCenter().x,y:this.getCenter().y,zoom:this.getZoom()/this.getCurrentRotationZooming(),rotation:this.getRotation()}},i.Controls.prototype.getCenter=function(){return this.image.viewer.viewport.getCenter(!0)},i.Controls.prototype.setCenter=function(e){this.image.viewer.viewport.panTo(e,!0)},i.Controls.prototype.getZoom=function(){return this.image.viewer.viewport.getZoom(!0)},i.Controls.prototype.zoomTo=function(e){var t=parseFloat(e)/this.image.viewer.viewport.getZoom();this.image.viewer.viewport.zoomBy(t,this.image.viewer.viewport.getCenter(!1),!0)},i.Controls.prototypesetFullScreen=function(e){this.image.viewer.setFullScreen(e)},i.Controls.prototype.goHome=function(e){this.image.viewer.viewport.goHome(e),this.zoomedOut=!0},i.Controls.prototype.reset=function(e){this.goHome(!0),this.image.viewer.viewport.zoomTo(this.image.viewer.viewport.getHomeZoom(),null,!0),e&&this.rotateTo(0)},i.Controls.prototype.zoomIn=function(){this.image.viewer.viewport.zoomBy(this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},i.Controls.prototype.zoomOut=function(){this.image.viewer.viewport.zoomBy(1/this.config.global.zoomSpeed,this.image.viewer.viewport.getCenter(!1),!1)},i.Controls.prototype.rotateRight=function(){var e=this.image.viewer.viewport.getRotation()+90;this.rotateTo(e)},i.Controls.prototype.rotateLeft=function(){var e=this.image.viewer.viewport.getRotation()-90;this.rotateTo(e)},i.Controls.prototype.getRotation=function(){return this.image.viewer.viewport.getRotation()},i.Controls.prototype.setRotation=function(e){return this.rotateTo(e)},i.Controls.prototype.rotateTo=function(e){e<0&&(e+=360),e%=360,this.panning=!0,this.currentZoom=null,this.image.viewer.viewport.setRotation(e),this.panning=!1},i.Controls.prototype.getCurrentRotationZooming=function(){var e=this.image.getSizes();return e&&e.rotated()?1/e.ratio(e.originalImageSize):1},i.Controls.prototype.setPanning=function(e){this.panning=e},i.Controls.prototype.isPanning=function(){return this.panning},i.Controls.prototype.fullscreenControlsFadeout=function(){this.fadeout&&(clearTimeout(this.fadeout),this.showFullscreenControls()),this.fadeout=setTimeout(this.hideFullscreenControls,3e3)},i.Controls.prototype.hideFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").stop().fadeOut("slow")},i.Controls.prototype.showFullscreenControls=function(){$("#fullscreenRotateControlsWrapper, #fullscreenZoomSliderWrapper, #fullscreenExitWrapper, #fullscreenPrevWrapper, #fullscreenNextWrapper").show()},i.Controls.prototype.setLocation=function(e){this.image.viewer.viewport.minZoomLevel=this.image.viewer.viewport.getHomeZoom()*this.config.global.minZoomLevel;var t=e.targetLocation.zoom,o=new OpenSeadragon.Point(e.targetLocation.x,e.targetLocation.y);(t*this.image.viewer.viewport.getHomeZoom()-this.image.viewer.viewport.minZoomLevel<.001||!t)&&this.image.config.global.fitToContainer?this.goHome(!0):(this.image.config.global.fitToContainer&&this.image.viewer.viewport.zoomTo(t*this.getCurrentRotationZooming(),null,!0),this.setCenter(o)),"open"===e.osState&&0!==e.targetLocation.rotation&&this.rotateTo(e.targetLocation.rotation)},i}(ImageView))))))))));ImageView=function(e){"use strict";var n=!1,i={},o={sliderDilation:12};return e.ZoomSlider=function(e,t){this.config=$.extend(!0,{},o),$.extend(!0,this.config,e.global),this.image=t},e.ZoomSlider.prototype.init=function(){n&&(console.log("##############################"),console.log("imageView.zoomSlider.init"),console.log("##############################")),this.addZoomSlider(this.config.zoomSlider),this.buttonToZoom(this.image.viewer.viewport.getHomeZoom());var o=this;this.image.observables.viewerZoom.subscribe(function(e){var t=o.image.viewer.viewport.getZoom();o.buttonToZoom(t)})},e.ZoomSlider.prototype.exists=function(){return this.$element.length&&this.$button.length},e.ZoomSlider.prototype.buttonToMouse=function(e){n&&console.log("imageView.zoomSlider.buttonToMouse: mousePos - "+e);var t=this.$button.width()/2,o=e-t;o<0&&(o=0),o+2*t>this.absoluteWidth&&(o=this.absoluteWidth-2*t),this.$button.css({left:o});var i=(this.buttonPosition=o)/(this.absoluteWidth-2*t);i=1/this.config.sliderDilation*Math.tan(Math.atan(this.config.sliderDilation)*i);var r=this.image.viewer.viewport.getMinZoom()+(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom())*i;n&&console.log("imageView.zoomSlider.buttonToMouse: newScale - "+r),this.zoomTo(r)},e.ZoomSlider.prototype.zoomTo=function(e){n&&console.log("imageView.controls.myZoomTo: zoomTo - "+e);var t=parseFloat(e)/this.image.viewer.viewport.getZoom();n&&console.log("imageView.controls.myZoomTo: zoomBy - "+t),this.image.viewer.viewport.zoomBy(t,this.image.viewer.viewport.getCenter(!1),!0),this.setLabel(e)},e.ZoomSlider.prototype.buttonToZoom=function(e){if(n&&(console.log("imageView.zoomSlider.buttonToZoom: scale - "+e),console.log("imageView.zoomSlider.buttonToZoom: _zoomSlider - ",i)),this.image.viewer.viewport){if(this.$button){var t=(e-this.image.viewer.viewport.getMinZoom())/(this.image.viewer.viewport.getMaxZoom()-this.image.viewer.viewport.getMinZoom()),o=(t=1/Math.atan(this.config.sliderDilation)*Math.atan(this.config.sliderDilation*t))*(this.absoluteWidth-this.$button.width());Math.abs(this.image.viewer.viewport.getMaxZoom()-e)<1e-10&&(o=this.absoluteWidth-this.$button.width()),o<0&&(o=0),this.$button.css({left:o}),this.buttonPosition=o}this.setLabel(e)}},e.ZoomSlider.prototype.setLabel=function(e){if(this.$label.length&&this.image.sizes){var t=this.image.config.image.originalImageWidth,o=this.image.container.width();e=parseFloat(e)/t*o,this.$label.val((100*e).toFixed(1))}},e.ZoomSlider.prototype.inputToZoom=function(e){var t=parseFloat(e);if(t&&this.image.sizes){n&&console.log("scale to ",e);var o=t*this.image.config.image.originalImageWidth/this.image.container.width()/100;o<this.image.viewer.viewport.getMinZoom()?o=this.image.viewer.viewport.getMinZoom():o>this.image.viewer.viewport.getMaxZoom()&&(o=this.image.viewer.viewport.getMaxZoom()),this.zoomTo(o)}},e.ZoomSlider.prototype.addZoomSlider=function(e){n&&console.log("imageView.zoomSlider.addZoomSlider: element - "+e),this.buttonPosition=0,this.$element=$(e),this.absoluteWidth=this.$element.innerWidth(),this.mousedown=!1;var t=this;this.$element.length&&(this.$button=this.$element.children(this.config.zoomSliderHandle),this.$element.on("mousedown",function(e){!function(e,t){n&&console.log("imageView.zoomSlider.zoomSliderMouseDown: evt - "+e);t.mousedown=!0;var o=t.$element.offset(),i=e.pageX-o.left;t.buttonToMouse(i)}(e,t)}),this.$element.on("mousemove",function(e){!function(e,t){n&&console.log("imageView.zoomSlider.zoomSliderMouseMove: evt - "+e);if(!t.mousedown)return;var o=t.$element.offset(),i=e.pageX-o.left;t.buttonToMouse(i),n&&console.log("imageView.zoomSlider.zoomSliderMouseMove: moving - "+i)}(e,t)}),this.$button.length&&this.$button.on("mousedown",function(e){!function(e,t){n&&console.log("imageView.zoomSlider.buttonMouseDown");t.mousedown=!0}(0,t)})),this.$label=$(this.config.zoomSliderLabel),this.$label.length&&(this.$label.on("change",function(e){return t.inputToZoom(e.target.value),!1}),this.$label.on("keypress",function(e){if(13==e.which)return t.inputToZoom(e.target.value),!1})),$(document).on("mouseup",function(e){!function(e,t){n&&console.log("imageView.zoomSlider.zoomSliderMouseUp");t.mousedown=!1}(0,t)})},e}(ImageView=function(l){"use strict";var a="default",s=!1,o="transforming",g=.004;function c(e,t,o){var i=v(t,e.getTopLeft(),e.getBottomLeft()),r=v(t,e.getBottomLeft(),e.getBottomRight()),n=v(t,e.getTopRight(),e.getBottomRight()),a=v(t,e.getTopLeft(),e.getTopRight()),s=Math.min(i,Math.min(n,Math.min(a,r)));if(s<=o){if(i===s)return l.TransformRect.HitAreas.LEFT;if(n===s)return l.TransformRect.HitAreas.RIGHT;if(a===s)return l.TransformRect.HitAreas.TOP;if(r===s)return l.TransformRect.HitAreas.BOTTOM}return""}function h(e,t,o){var i=u(t,e.getTopLeft()),r=u(t,e.getBottomLeft()),n=u(t,e.getTopRight()),a=u(t,e.getBottomRight()),s=Math.min(i,Math.min(n,Math.min(r,a)));if(s<=o){if(i===s)return l.TransformRect.HitAreas.TOPLEFT;if(n===s)return l.TransformRect.HitAreas.TOPRIGHT;if(r===s)return l.TransformRect.HitAreas.BOTTOMLEFT;if(a===s)return l.TransformRect.HitAreas.BOTTOMRIGHT}return""}function i(e){return e*e}function n(e,t){return i(e.x-t.x)+i(e.y-t.y)}function u(e,t){return Math.sqrt(n(e,t))}function v(e,t,o){return Math.sqrt(function(e,t,o){var i=n(t,o);if(0==i)return n(e,t);var r=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/i;return n(e,r<0?t:1<r?o:{x:t.x+r*(o.x-t.x),y:t.y+r*(o.y-t.y)})}(e,t,o))}return l.TransformRect=function(e,t){s&&(console.log("##############################"),console.log("osViewer.transformRect.init"),console.log("##############################")),this.config=e,this.image=t;var o=this;this.viewerInputHook=t.viewer.addViewerInputHook({hooks:[{tracker:"viewer",handler:"clickHandler",hookHandler:function(e){!function(e,t){if(t.drawing)e.preventDefaultAction=!0}(e,o)}},{tracker:"viewer",handler:"dragHandler",hookHandler:function(e){!function(e,t){{if(t.drawing){var o,i,r=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),n=t.image.overlays.getDrawingOverlay().rect;if(t.drawArea===l.TransformRect.HitAreas.TOPLEFT)o=new OpenSeadragon.Point(Math.min(r.x,n.getBottomRight().x),Math.min(r.y,n.getBottomRight().y)),i=n.getBottomRight();else if(t.drawArea===l.TransformRect.HitAreas.TOPRIGHT)o=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(r.y,n.getBottomRight().y)),i=new OpenSeadragon.Point(Math.max(r.x,n.getTopLeft().x),n.getBottomRight().y);else if(t.drawArea===l.TransformRect.HitAreas.BOTTOMLEFT)o=new OpenSeadragon.Point(Math.min(r.x,n.getBottomRight().x),n.getTopLeft().y),i=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(r.y,n.getTopLeft().y));else if(t.drawArea===l.TransformRect.HitAreas.BOTTOMRIGHT)o=n.getTopLeft(),i=new OpenSeadragon.Point(Math.max(r.x,n.getTopLeft().x),Math.max(r.y,n.getTopLeft().y));else if(t.drawArea===l.TransformRect.HitAreas.LEFT)o=new OpenSeadragon.Point(Math.min(r.x,n.getBottomRight().x),n.getTopLeft().y),i=n.getBottomRight();else if(t.drawArea===l.TransformRect.HitAreas.RIGHT)o=n.getTopLeft(),i=new OpenSeadragon.Point(Math.max(r.x,n.getTopLeft().x),n.getBottomRight().y);else if(t.drawArea===l.TransformRect.HitAreas.TOP)o=new OpenSeadragon.Point(n.getTopLeft().x,Math.min(r.y,n.getBottomRight().y)),i=n.getBottomRight();else if(t.drawArea===l.TransformRect.HitAreas.BOTTOM)o=n.getTopLeft(),i=new OpenSeadragon.Point(n.getBottomRight().x,Math.max(r.y,n.getTopLeft().y));else if(t.drawArea===l.TransformRect.HitAreas.CENTER&&t.enterPoint){var a=t.enterPoint.x-r.x,s=t.enterPoint.y-r.y;n.x-=a,n.y-=s,t.enterPoint=r}return o&&i&&(n.x=o.x,n.y=o.y,n.width=i.x-o.x,n.height=i.y-o.y),t.image.viewer.updateOverlay(t.image.overlays.getDrawingOverlay().element,n,0),e.preventDefaultAction=!0}if(t.drawArea)t.drawing=!0,e.preventDefaultAction=!0}}(e,o)}},{tracker:"viewer",handler:"pressHandler",hookHandler:function(e){!function(e,t){if(t.active){if(!t.image.overlays.getDrawingOverlay())return;var o=t.image.overlays.getDrawingOverlay().rect,i=t.image.overlays.getDrawingOverlay().element,r=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),n=h(o,r,g);n||(n=c(o,r,g)),!n&&t.image.overlays.contains(o,r,0)&&(n=l.TransformRect.HitAreas.CENTER),s&&console.log("draw area = "+n),n&&($(i).tooltip("destroy"),t.enterPoint=r),t.drawArea=n,e.preventDefaultAction=!0}}(e,o)}},{tracker:"viewer",handler:"dragEndHandler",hookHandler:function(e){!function(e,t){if(t.drawing)t.drawing=!1,e.preventDefaultAction=!0}(e,o)}},{tracker:"viewer",handler:"releaseHandler",hookHandler:function(e){!function(e,t){if(t.active)t.drawing&&t.finishHook&&t.finishHook(t.image.overlays.getDrawingOverlay()),t.drawing=!1,t.image.overlays.getDrawingOverlay()&&$(t.image.overlays.getDrawingOverlay().element).tooltip(),t.drawArea="",t.enterPoint=null,e.preventDefaultAction=!0}(e,o)}},{tracker:"viewer",handler:"moveHandler",hookHandler:function(e){!function(e,t){if(!t.drawing&&t.active){var o=t.image.viewer.viewport.viewerElementToViewportCoordinates(e.position),i=t.image.overlays.getDrawingOverlay().rect,r=(t.image.overlays.getDrawingOverlay().element,t.image.viewer.element),n=h(i,o,g);n||(n=c(i,o,g)),!n&&t.image.overlays.contains(i,o,0)&&(n=l.TransformRect.HitAreas.CENTER),n?$(r).css({cursor:l.TransformRect.HitAreas.getCursor(n,t.image)}):$(r).css({cursor:a}),e.preventDefaultAction=!0}}(e,o)}}]})},l.TransformRect.prototype.startDrawing=function(e,t){s&&console.log("Start drawing"),this.image.overlays.setDrawingOverlay(e),this.active=!0,this.group=e.group,this.finishHook=t,$(e.element).addClass(o)},l.TransformRect.prototype.endDrawing=function(){this.drawing=!1,this.group=null,this.finishHook=null,this.active=!1;var e=this.image.overlays.getDrawingOverlay();null!=e&&($(e.element).removeClass(o),$(e.element).css({cursor:a}))},l.TransformRect.prototype.isActive=function(){return this.active},l.TransformRect.HitAreas={TOP:"t",BOTTOM:"b",RIGHT:"r",LEFT:"l",TOPLEFT:"tl",TOPRIGHT:"tr",BOTTOMLEFT:"bl",BOTTOMRIGHT:"br",CENTER:"c",isCorner:function(e){return e===this.TOPRIGHT||e===this.TOPLEFT||e===this.BOTTOMLEFT||e===this.BOTTOMRIGHT},isEdge:function(e){return e===this.TOP||e===this.BOTTOM||e===this.LEFT||e===this.RIGHT},getCursor:function(e,t){var o=t.viewer.viewport.getRotation()%180==90;return e===this.TOPLEFT||e===this.BOTTOMRIGHT?o?"nesw-resize":"nwse-resize":e===this.TOPRIGHT||e===this.BOTTOMLEFT?o?"nwse-resize":"nesw-resize":e===this.TOP||e===this.BOTTOM?o?"ew-resize":"ns-resize":e===this.RIGHT||e===this.LEFT?o?"ns-resize":"ew-resize":e===this.CENTER?"move":a}},l}(ImageView=function(r){"use strict";return r.TileSourceResolver={resolveAsJsonOrURI:function(e){var t=Q.defer();return this.isJson(e)?t.resolve(e):this.isStringifiedJson(e)?t.resolve(JSON.parse(e)):t.resolve(e),t.promise},resolveAsJson:function(e){var t=Q.defer();if(this.isURI(e)){if(this.isJsonURI(e))return this.loadJsonFromURL(e);t.reject("Url does not lead to a json object")}else if("string"==typeof e)try{var o=JSON.parse(e);t.resolve(o)}catch(e){t.reject("String does not contain valid json: "+e)}else"object"==typeof e?t.resolve(e):t.reject("Neither a url nor a json object");return t.promise},loadJsonFromURL:function(e){var t=Q.defer();return this.isJsonURI(e)?OpenSeadragon.makeAjaxRequest(e,function(e){try{t.resolve(JSON.parse(e.responseText))}catch(e){t.reject(e)}},function(e){t.reject(e)}):t.reject("Not a json uri: "+e),t.promise},loadIfJsonURL:function(i){return Q.promise(function(t,o){if(r.TileSourceResolver.isURI(i)){var e={url:decodeURI(i),type:"GET",dataType:"JSON",async:!0,crossDomain:!0,accepts:{application_json:"application/json",application_jsonLd:"application/ld+json",text_json:"text/json",text_jsonLd:"text/ld+json"}};Q($.ajax(e)).then(function(e){t(e)}).fail(function(e){o("Failed to retrieve json from "+i)}),setTimeout(function(){o("Timeout after 10s")},1e4)}else o("Not a uri: "+i)})},isJsonURI:function(e){if(this.isURI(e)){var t=e.replace(/\?.*/,"");return t.endsWith("/")&&(t=t.substring(0,t.length-1)),t.toLowerCase().endsWith(".json")}return!1},isURI:function(e){return!(!e||"string"!=typeof e||!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("file:/")))},isStringifiedJson:function(e){if(e&&"string"==typeof e)try{var t=JSON.parse(e);return this.isJson(t)}catch(e){return!1}return!1},isJson:function(e){return e&&"object"==typeof e}},r}(ImageView)));
//# sourceMappingURL=viewImage.min.js.map