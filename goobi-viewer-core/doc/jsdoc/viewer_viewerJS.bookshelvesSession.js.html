<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: viewer/viewerJS.bookshelvesSession.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: viewer/viewerJS.bookshelvesSession.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This file is part of the Goobi viewer - a content presentation and management
 * application for digitized objects.
 * 
 * Visit these websites for more information. - http://www.intranda.com -
 * http://digiverso.com
 * 
 * This program is free software; you can redistribute it and/or modify it under the terms
 * of the GNU General Public License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 * PARTICULAR PURPOSE. See the GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with this
 * program. If not, see &lt;http://www.gnu.org/licenses/>.
 * 
 * Module to manage bookshelves in the current session.
 * 
 * @version 3.2.0
 * @module viewerJS.bookshelvesSession
 * @requires jQuery
 */
var viewerJS = (function(viewer) {
	'use strict';

	var _debug = false;
	var _confirmCounter = 0;
	var _defaults = {
		root : '',
		msg : {
			resetBookshelves : '',
			resetBookshelvesConfirm : '',
			saveItemToSession : ''
		}
	};

	viewer.bookshelvesSession = {
		init : function(config) {
			if (_debug) {
				console.log('##############################');
				console.log('viewer.bookshelvesSession.init');
				console.log('##############################');
				console.log('viewer.bookshelvesSession.init: config - ', config);
			}

			$.extend(true, _defaults, config);

			// set confirm counter to local storage
			if (localStorage.getItem('confirmCounter') == undefined) {
				localStorage.setItem('confirmCounter', 0);
			}

			// render bookshelf dropdown list
			_renderDropdownList();
			_renderMiradorLink();

			// toggle bookshelf dropdown
			$('[data-bookshelf-type="dropdown"]').off().on('click', function(event) {
				event.stopPropagation();

				// hide other dropdowns
				$('.login-navigation__login-dropdown, .login-navigation__user-dropdown, .navigation__collection-panel').hide();

				_getAllSessionElements(_defaults.root).then(function(elements) {
					if (elements.items.length > 0) {
						$('.bookshelf-navigation__dropdown').slideToggle('fast');
					} else {
						return false;
					}
				}).fail(function(error) {
					console.error('ERROR - _getAllSessionElements: ', error.responseText);
				});
			});

			// set element count of list to counter
			_setSessionElementCount();

			// check add buttons if element is in list
			_setAddActiveState();

			// add element to session
			$('[data-bookshelf-type="add"]').off().on('click', function() {
				var currBtn = $(this);
				var currPi = currBtn.attr('data-pi');

				_isElementSet(_defaults.root, currPi).then(function(isSet) {
					// set confirm counter
					_confirmCounter = parseInt(localStorage.getItem('confirmCounter'));

					if (!isSet) {
						if (_confirmCounter == 0) {
							if (confirm(_defaults.msg.saveItemToSession)) {
								currBtn.addClass('added');
								localStorage.setItem('confirmCounter', 1);
								_setSessionElement(_defaults.root, currPi).then(function() {
									_setSessionElementCount();
									_renderDropdownList();
									_renderMiradorLink();
								});
							} else {
								return false;
							}
						} else {
							currBtn.addClass('added');
							_setSessionElement(_defaults.root, currPi).then(function() {
								_setSessionElementCount();
								_renderDropdownList();
								_renderMiradorLink();
							});
						}
					} else {
						currBtn.removeClass('added');
						_deleteSessionElement(_defaults.root, currPi).then(function() {
							_setSessionElementCount();
							_renderDropdownList();
							_renderMiradorLink();
						});
					}
				}).fail(function(error) {
					console.error('ERROR - _isElementSet: ', error.responseText);
				});
			});

			// hide menus by clicking on body
			$('body').on('click', function(event) {
				var target = $(event.target);
				var dropdown = $('.bookshelf-navigation__dropdown');
				var dropdownChild = dropdown.find('*');

				if (!target.is(dropdown) &amp;&amp; !target.is(dropdownChild)) {
					$('.bookshelf-navigation__dropdown').hide();
				}
			});
		}
	};
	/* ######## ADD (CREATE) ######## */

	/* ######## GET (READ) ######## */
	/**
	 * Method to get all elements in watchlist from current session (user not logged in).
	 * 
	 * @method _getAllSessionElements
	 * @param {String} root The application root path.
	 * @returns {Object} An JSON-Object which contains all session elements.
	 */
	function _getAllSessionElements(root) {
		if (_debug) {
			console.log('---------- _getAllSessionElements() ----------');
			console.log('_getAllSessionElements: root - ', root);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/get/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise;
	}
	/**
	 * Method to get the number of objects in session.
	 * 
	 * @method _getSessionElementCount
	 * @param {String} root The application root path.
	 * @returns {Object} An JSON-Object which contains all session elements.
	 */
	function _getSessionElementCount(root) {
		if (_debug) {
			console.log('---------- _getSessionElementCount() ----------');
			console.log('_getSessionElementCount: root - ', root);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/count/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise
	}
	/**
	 * Method to check if element is in list (user not logged in).
	 * 
	 * @method _isElementSet
	 * @param {String} root The application root path.
	 * @param {String} pi The persistent identifier of the saved element.
	 * @returns {Boolean} True if element is set.
	 */
	function _isElementSet(root, pi) {
		if (_debug) {
			console.log('---------- _isElementSet() ----------');
			console.log('_isElementSet: root - ', root);
			console.log('_isElementSet: pi - ', pi);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/contains/' + pi + '/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise
	}

	/* ######## SET (UPDATE) ######## */
	/**
	 * Method to add an elements to watchlist in current session (user not logged in).
	 * 
	 * @method _setSessionElement
	 * @param {String} root The application root path.
	 * @param {String} pi The persistent identifier of the saved element.
	 */
	function _setSessionElement(root, pi) {
		if (_debug) {
			console.log('---------- _setSessionElement() ----------');
			console.log('_setSessionElement: root - ', root);
			console.log('_setSessionElement: pi - ', pi);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/add/' + pi + '/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise
	}

	/* ######## DELETE ######## */
	/**
	 * Method to delete an element from watchlist in current session (user not logged in).
	 * 
	 * @method _deleteSessionElement
	 * @param {String} root The application root path.
	 * @param {String} pi The persistent identifier of the saved element.
	 */
	function _deleteSessionElement(root, pi) {
		if (_debug) {
			console.log('---------- _deleteSessionElement() ----------');
			console.log('_deleteSessionElement: root - ', root);
			console.log('_deleteSessionElement: pi - ', pi);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/delete/' + pi + '/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise
	}
	/**
	 * Method to delete all elements from watchlist in current session (user not logged
	 * in).
	 * 
	 * @method _deleteAllSessionElements
	 * @param {String} root The application root path.
	 */
	function _deleteAllSessionElements(root) {
		if (_debug) {
			console.log('---------- _deleteAllSessionElements() ----------');
			console.log('_deleteAllSessionElements: root - ', root);
		}

		var promise = Q($.ajax({
			url : root + '/rest/bookshelves/session/delete/',
			type : "GET",
			dataType : "JSON",
			async : true
		}));

		return promise
	}

	/* ######## BUILD ######## */
	/**
	 * Method to set the count of elements in watchlist from current session (user not
	 * logged in).
	 * 
	 * @method _setSessionElementCount
	 * @param {String} root The application root path.
	 */
	function _setSessionElementCount() {
		if (_debug) {
			console.log('---------- _setSessionElementCount() ----------');
		}

		_getAllSessionElements(_defaults.root).then(function(elements) {
			$('[data-bookshelf-type="counter"]').empty().text(elements.items.length).addClass( 'in' );
		}).fail(function(error) {
			console.error('ERROR - _getAllSessionElements: ', error.responseText);
		});
	}
	/**
	 * Method to render the element list in bookshelf dropdown (user not logged in).
	 * 
	 * @method _renderDropdownList
	 */
	function _renderDropdownList() {
		if (_debug) {
			console.log('---------- _renderDropdownList() ----------');
		}

		_getAllSessionElements(_defaults.root).then(function(elements) {
			// DOM-Elements
			var dropdownListReset = $('&lt;button>').addClass('btn btn--clean').attr('type', 'button').attr('data-bookshelf-type', 'reset').html('&lt;span>' + _defaults.msg.resetBookshelves + '&lt;/span>&lt;i class="fa fa-trash-o" aria-hidden="true">&lt;/i>');
			var dropdownList = $('&lt;ul />').addClass('list');
			var dropdownListItem = null;
			var dropdownListItemRow = null;
			var dropdownListItemColLeft = null;
			var dropdownListItemColCenter = null;
			var dropdownListItemColRight = null;
			var dropdownListItemImage = null;
			var dropdownListItemName = null;
			var dropdownListItemNameLink = null;
			var dropdownListItemDelete = null;

			// set confirm counter
			if (elements.items.length &lt; 1) {
				localStorage.setItem('confirmCounter', 0);
			}

			elements.items
				.forEach(function(item) {
					dropdownListItem = $('&lt;li />');
					dropdownListItemRow = $('&lt;div />').addClass('row no-margin');
					dropdownListItemColLeft = $('&lt;div />').addClass('col-xs-4 no-padding');
					dropdownListItemColCenter = $('&lt;div />').addClass('col-xs-7 no-padding');
					dropdownListItemColRight = $('&lt;div />').addClass('col-xs-1 no-padding bookshelf-navigation__dropdown-list-remove');
					dropdownListItemImage = $('&lt;div />').addClass('bookshelf-navigation__dropdown-list-image').css('background-image', 'url('
						+ item.representativeImageUrl + ')');
					dropdownListItemName = $('&lt;h4 />');
					dropdownListItemNameLink = $('&lt;a />').attr('href', _defaults.root + item.url).text(item.name);
					dropdownListItemDelete = $('&lt;button />').addClass('btn btn--clean').attr('type', 'button').attr('data-bookshelf-type', 'delete')
						.attr('data-pi', item.pi).html('&lt;i class="fa fa-ban" aria-hidden="true">&lt;/i>');

					// build bookshelf item
					dropdownListItemName.append(dropdownListItemNameLink);
					dropdownListItemColLeft.append(dropdownListItemImage);
					dropdownListItemColCenter.append(dropdownListItemName);
					dropdownListItemColRight.append(dropdownListItemDelete);
					dropdownListItemRow.append(dropdownListItemColLeft).append(dropdownListItemColCenter).append(dropdownListItemColRight);
					dropdownListItem.append(dropdownListItemRow);
					dropdownList.append(dropdownListItem);
				});

			// render complete list
			$('.bookshelf-navigation__dropdown-list').empty().append(dropdownList);

			// render reset if items exist
			if (elements.items.length > 0) {
				$('.bookshelf-navigation__dropdown-list-reset').empty().append(dropdownListReset);
			} else {
				$('.bookshelf-navigation__dropdown').hide();
				$('.bookshelf-navigation__dropdown-list-reset').empty();
			}

			// delete single item
			$('[data-bookshelf-type="delete"]').on('click', function() {
				var currBtn = $(this);
				var currPi = currBtn.attr('data-pi');

				_deleteSessionElement(_defaults.root, currPi).then(function() {
					_setSessionElementCount();
					_setAddActiveState();
					_renderDropdownList();
					_renderMiradorLink();
				});
			});

			// delete all items
			$('[data-bookshelf-type="reset"]').on('click', function() {
				if (confirm(_defaults.msg.resetBookshelvesConfirm)) {
					_deleteAllSessionElements(_defaults.root).then(function() {
						localStorage.setItem('confirmCounter', 0);
						_setSessionElementCount();
						_setAddActiveState();
						_renderDropdownList();
						_renderMiradorLink();
					});
				} else {
					return false;
				}
			});

		}).fail(function(error) {
			console.error('ERROR - _getAllSessionElements: ', error.responseText);
		});
	}
	/**
	 * Method to render the element list in bookshelf dropdown (user not logged in).
	 * 
	 * @method _renderMiradorLink
	 */
	function _renderMiradorLink() {
		if (_debug) {
			console.log('---------- _renderMiradorLink() ----------');
		}

		_getSessionElementCount(_defaults.root).then(function(elements) {
			if ( elements > 1 ) {
				$( '.bookshelf-navigation__dropdown-list-mirador' ).removeClass( 'hidden' );
			}
			else {
				$( '.bookshelf-navigation__dropdown-list-mirador' ).addClass( 'hidden' );
			}
		}).fail(function(error) {
			console.error('ERROR - _getSessionElementCount: ', error.responseText);
		});
	}
	/**
	 * Method to set the active state of add buttons (user not logged in).
	 * 
	 * @method _setAddActiveState
	 */
	function _setAddActiveState() {
		if (_debug) {
			console.log('---------- _setAddActiveState() ----------');
		}

		$('[data-bookshelf-type="add"]').each(function() {
			var currBtn = $(this);
			var currPi = currBtn.attr('data-pi');

			_isElementSet(_defaults.root, currPi).then(function(isSet) {
				if (isSet) {
					currBtn.addClass('added');
				} else {
					currBtn.removeClass('added');
				}
			}).fail(function(error) {
				console.error('ERROR - _isElementSet: ', error.responseText);
			});
		});
	}

	return viewer;

})(viewerJS || {}, jQuery);

// /rest/bookshelves/session/add/{pi}/{logid}/{page}
// Fügt der Merkliste ein Item mit der angegebenen pi, logId und Seitennummer an. Der Name
// des Items wird automatisch aus dem zur pi gehörenden SOLR-Dokument erstellt
// /rest/bookshelves/session/delete/{pi}/{logid}/{page}
// Löscht das Item mit der angegebenen pi, logid und Seitennummer aus der Merkliste, wenn
// es enthalten ist
// /rest/bookshelves/session/contains/{pi}/{logid}/{page}
// gibt "true" zurück, wenn die Merkliste ein Item mit der angegebenen pi, logid und
// Seitennummer enthält; sonst "false"</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="cmsJS.module_createPage.html">createPage</a></li><li><a href="cmsJS.module_geoLocations.html">geoLocations</a></li><li><a href="cmsJS.module_masonry.html">masonry</a></li><li><a href="cmsJS.module_rssFeed.html">rssFeed</a></li><li><a href="cmsJS.module_sortableList.html">sortableList</a></li><li><a href="cmsJS.module_stackedCollection.html">stackedCollection</a></li><li><a href="cmsJS.module_staticGrid.html">staticGrid</a></li><li><a href="cmsJS.module_tagList.html">tagList</a></li><li><a href="cmsJS.module_tileGrid.html">tileGrid</a></li><li><a href="module-cmsJS.html">cmsJS</a></li><li><a href="module-viewerJS.html">viewerJS</a></li><li><a href="viewerJS.module_bookshelvesSession.html">bookshelvesSession</a></li><li><a href="viewerJS.module_bookshelvesUser.html">bookshelvesUser</a></li><li><a href="viewerJS.module_calendarPopover.html">calendarPopover</a></li><li><a href="viewerJS.module_changeFontSize.html">changeFontSize</a></li><li><a href="viewerJS.module_chronoSlider.html">chronoSlider</a></li><li><a href="viewerJS.module_dataTable.html">dataTable</a></li><li><a href="viewerJS.module_dateSortedFeed.html">dateSortedFeed</a></li><li><a href="viewerJS.module_download.html">download</a></li><li><a href="viewerJS.module_downloadModal.html">downloadModal</a></li><li><a href="viewerJS.module_helper.html">helper</a></li><li><a href="viewerJS.module_mirador.html">mirador</a></li><li><a href="viewerJS.module_navigation.html">navigation</a></li><li><a href="viewerJS.module_nerFacetting.html">nerFacetting</a></li><li><a href="viewerJS.module_nerFulltext.html">nerFulltext</a></li><li><a href="viewerJS.module_normdata.html">normdata</a></li><li><a href="viewerJS.module_pageScroll.html">pageScroll</a></li><li><a href="viewerJS.module_paginator.html">paginator</a></li><li><a href="viewerJS.module_responsiveColumnGallery.html">responsiveColumnGallery</a></li><li><a href="viewerJS.module_searchAdvanced.html">searchAdvanced</a></li><li><a href="viewerJS.module_searchList.html">searchList</a></li><li><a href="viewerJS.module_searchSortingDropdown.html">searchSortingDropdown</a></li><li><a href="viewerJS.module_simpleLightbox.html">simpleLightbox</a></li><li><a href="viewerJS.module_stackedThumbnails.html">stackedThumbnails</a></li><li><a href="viewerJS.module_timematrix.html">timematrix</a></li><li><a href="viewerJS.module_tinyMce.html">tinyMce</a></li><li><a href="viewerJS.module_userComments.html">userComments</a></li><li><a href="viewerJS.module_userDropdown.html">userDropdown</a></li><li><a href="viewerJS.module_versionHistory.html">versionHistory</a></li><li><a href="viewImage.controls.module_persistence.html">persistence</a></li><li><a href="viewImage.module_controls.html">controls</a></li><li><a href="viewImage.module_drawRect.html">drawRect</a></li><li><a href="viewImage.module_Measures.html">Measures</a></li><li><a href="viewImage.module_overlays.html">overlays</a></li><li><a href="viewImage.module_readingMode.html">readingMode</a></li><li><a href="viewImage.module_tileSourceResolver.html">tileSourceResolver</a></li><li><a href="viewImage.module_transformRect.html">transformRect</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ImageView">ImageView</a></li><li><a href="global.html#Statistics">Statistics</a></li><li><a href="global.html#WorldGenerator">WorldGenerator</a></li><li><a href="global.html#X3DLoader">X3DLoader</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Nov 15 2018 08:16:40 GMT+0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
